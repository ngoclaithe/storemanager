<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overview</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="../../static/css/overview.css">

</head>

<body>
    <nav class="navbar navbar-custom navbar-expand-lg">
        <a class="navbar-brand" href="#">
            <img src="../../static/img/logo_login.png" alt="Logo" style="width: 40px; margin-right: 10px;">
            Thanh Hải Store
            <img src="../../static/img/more.png" alt="More" id="toggleSidebar"
                style="width: 40px; margin-right: 10px; cursor: pointer;">
        </a>
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a class="nav-link" href="#">
                    <div id="notification-icon">
                        <img src="../../static/img/notification.png" alt="Thông báo" class="notification-icon">
                    </div>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/account">
                    <img src="../../static/img/user.png" alt="Tài khoản" class="account-icon">
                </a>
            </li>
        </ul>
    </nav>
    <div id="notification-popup" class="notification-popup" style="display: none;">
        <table class="table">
            <thead>
                <tr>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="notification-body">
            </tbody>
        </table>
    </div>

    <div class="sidebar" id="sidebar">
        <a href="/overview" class="active"><i class="fas fa-tachometer-alt"></i> Tổng quan</a>
        <a href="/product"><i class="fas fa-box-open"></i> Hàng hóa</a>
        <a href="/transaction"><i class="fas fa-exchange-alt"></i> Giao dịch</a>
        <a href="/treasury"><i class="fas fa-wallet"></i> Sổ quỹ</a>
        <a href="/report"><i class="fas fa-chart-line"></i> Báo cáo</a>
        <a href="/staff"><i class="fas fa-users"></i> Nhân viên</a>
    </div>

    <div class="content" id="content">
        <div class="card-container">
            <h1>Tổng quan</h1>
            <div class="main-content">
                <div id="chart-container">
                    <canvas id="salesChart"></canvas>
                </div>

                <div class="widgets">
                    <div class="widget">
                        <img src="../../static/img/product_overview.png" alt="Product Overview">
                        <h2>Sản phẩm bán hôm nay</h2>
                        <p id="sold-today">0</p>
                    </div>
                    <div class="widget">
                        <img src="../../static/img/revenue.png" alt="Revenue Today">
                        <h2>Doanh thu hôm nay</h2>
                        <p id="revenue-today">0</p>
                    </div>
                    <div class="widget">
                        <img src="../../static/img/product_2.png" alt="Sold Product">
                        <h2>Loại sản phẩm bán</h2>
                        <p id="sold-product">0</p>
                    </div>
                    <div class="widget">
                        <img src="../../static/img/revenue_2.png" alt="Revenue Yesterday">
                        <h2>Doanh thu hôm qua</h2>
                        <p id="revenue-yesterday">0</p>
                    </div>
                </div>
            </div>

            <div class="map-container">
                <h2>Lượng truy cập</h2>
                <div id="worldMap" style="height: 400px;"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script src="../../static/script/script.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />

    <script>
        var userName = "{{ user_name }}";

        async function fetchSalesData() {
            const response = await fetch('/sales_today');
            const data = await response.json();

            document.getElementById('sold-today').innerText = data.sold_today;
            document.getElementById('revenue-today').innerText = data.revenue_today;
            document.getElementById('sold-product').innerText = data.sold_product;
            document.getElementById('revenue-yesterday').innerText = data.revenue_yesterday;
            renderChart(data.sales_over_time);
        }

        function renderChart(salesData) {
            const ctx = document.getElementById('salesChart').getContext('2d');

            const salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: salesData.dates,
                    datasets: [{
                        label: 'Doanh thu',
                        data: salesData.revenue,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        document.getElementById('toggleSidebar').addEventListener('click', function () {
            const sidebar = document.getElementById('sidebar');
            const content = document.getElementById('content');
            sidebar.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
        });

        window.onload = function () {
            fetchSalesData();
            renderMap();
        };

        function renderMap() {
            const map = L.map('worldMap').setView([20, 0], 2);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '© OpenStreetMap'
            }).addTo(map);
        }

    </script>
    <script src="../../static/script/script.js"></script>
</body>

</html>